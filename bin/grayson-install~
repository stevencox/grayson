#!/bin/bash

set -e
#set -x

source $GRAYSON_HOME/bin/grayson-install-lib

grayson-usage () {
    echo "usage:"
    return 1
    }

grayson-install-app () {
    svn co https://renci-ci.svn.sourceforge.net/svnroot/renci-ci/trunk/grayson grayson
    cd 
    mkdir -p var/logs
    chmod 777 var/logs
    cp conf/dev.conf conf/grayson.conf
    #python web/manage.py syncdb
}


getarg () {
    echo $1 | sed s,.*=,,
}
function main () {
	local clean=
	local module=
	
	for arg in $*; do
	    case $arg in
		--module\=*)          env=$( getarg $arg );;
		--clean)              clean=true;;
		--stack-location\=*)  GRAYSON_STACK=$( getarg $arg );;
		--venv-location\=*)   GRAYSON_HOME=$( getarg $arg );;
            esac
	done

	if [ "x$clean" == "xtrue" ]; then
	    rm -rf $GRAYSON_STACK
	    mkdir -p $GRAYSON_STACK
	fi

	if [ -z "$GRAYSON_HOME" ]; then
	    grayson-usage
	    return 1
	fi
	
	if [ -z "$GRAYSON_STACK" ]; then
	    export GRAYSON_STACK=$PWD/stack
	    mkdir -p $GRAYSON_STACK
	fi

	#$GRAYSON_HOME/bin/venv --app
	
	if [ ! -z "$module" ]; then
	    install_$module
	else
	    install_all
	fi
    }

main $*
